# Virtual Audience Platform v2.0 - Production Database Schema

## Critical Missing Table Analysis

The production deployment failure was caused by the **missing `session` table** which is absolutely required for Passport.js authentication. This table stores user authentication sessions and without it, the application cannot authenticate users.

## Complete Database Schema Requirements

### Required ENUM Types
```sql
CREATE TYPE user_role AS ENUM ('admin', 'engineer', 'user');
CREATE TYPE message_type AS ENUM ('individual', 'broadcast', 'system');
```

### Required Tables (All 9 Tables)

#### 1. **session** - CRITICAL for Authentication
```sql
CREATE TABLE "session" (
    "sid" varchar PRIMARY KEY NOT NULL,
    "sess" jsonb NOT NULL,
    "expire" timestamp NOT NULL
);
```
**Purpose**: Stores Passport.js authentication sessions
**Failure Impact**: Without this table, NO authentication works

#### 2. **users** - User Management
```sql
CREATE TABLE "users" (
    "id" integer PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    "username" varchar(50) NOT NULL,
    "password" text NOT NULL,
    "email" varchar(100),
    "role" user_role DEFAULT 'user' NOT NULL,
    "created_at" timestamp DEFAULT now() NOT NULL,
    "updated_at" timestamp DEFAULT now() NOT NULL,
    CONSTRAINT "users_username_unique" UNIQUE("username")
);
```

#### 3. **generated_links** - Guest Streaming Links
```sql
CREATE TABLE "generated_links" (
    "id" text PRIMARY KEY NOT NULL,
    "stream_name" text NOT NULL,
    "return_feed" text NOT NULL,
    "chat_enabled" boolean DEFAULT false NOT NULL,
    "url" text NOT NULL,
    "session_token" text UNIQUE,
    "created_at" timestamp DEFAULT now() NOT NULL,
    "expires_at" timestamp,
    "created_by" integer REFERENCES "users"("id")
);
```

#### 4. **short_links** - URL Shortening for Guest Links
```sql
CREATE TABLE "short_links" (
    "id" text PRIMARY KEY NOT NULL,
    "stream_name" text NOT NULL,
    "return_feed" text NOT NULL,
    "chat_enabled" boolean DEFAULT false NOT NULL,
    "session_token" text UNIQUE,
    "created_at" timestamp DEFAULT now() NOT NULL,
    "expires_at" timestamp,
    "created_by" integer REFERENCES "users"("id")
);
```

#### 5. **viewer_links** - Studio Monitoring Links
```sql
CREATE TABLE "viewer_links" (
    "id" text PRIMARY KEY NOT NULL,
    "return_feed" text NOT NULL,
    "chat_enabled" boolean DEFAULT false NOT NULL,
    "url" text NOT NULL,
    "session_token" text UNIQUE,
    "created_at" timestamp DEFAULT now() NOT NULL,
    "expires_at" timestamp,
    "created_by" integer REFERENCES "users"("id")
);
```

#### 6. **short_viewer_links** - URL Shortening for Viewer Links
```sql
CREATE TABLE "short_viewer_links" (
    "id" text PRIMARY KEY NOT NULL,
    "return_feed" text NOT NULL,
    "chat_enabled" boolean DEFAULT false NOT NULL,
    "session_token" text UNIQUE,
    "created_at" timestamp DEFAULT now() NOT NULL,
    "expires_at" timestamp,
    "created_by" integer REFERENCES "users"("id")
);
```

#### 7. **session_tokens** - Security Token Management
```sql
CREATE TABLE "session_tokens" (
    "id" text PRIMARY KEY NOT NULL,
    "link_id" text,
    "link_type" text,
    "created_at" timestamp DEFAULT now() NOT NULL,
    "expires_at" timestamp NOT NULL,
    "created_by" integer REFERENCES "users"("id")
);
```

#### 8. **chat_messages** - Chat System Messages
```sql
CREATE TABLE "chat_messages" (
    "id" integer PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    "session_id" text NOT NULL,
    "sender_id" integer REFERENCES "users"("id"),
    "sender_name" text NOT NULL,
    "recipient_id" integer REFERENCES "users"("id"),
    "message_type" message_type DEFAULT 'individual' NOT NULL,
    "content" text NOT NULL,
    "created_at" timestamp DEFAULT now() NOT NULL
);
```

#### 9. **chat_participants** - Chat Session Management
```sql
CREATE TABLE "chat_participants" (
    "id" integer PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    "session_id" text NOT NULL,
    "user_id" integer REFERENCES "users"("id"),
    "username" text NOT NULL,
    "role" user_role NOT NULL,
    "is_online" boolean DEFAULT true NOT NULL,
    "joined_at" timestamp DEFAULT now() NOT NULL,
    "last_seen_at" timestamp DEFAULT now() NOT NULL
);
```

## Production Deployment Instructions

### Step 1: Use Updated init.sql
Replace your existing `init.sql` with the comprehensive version that includes ALL 9 tables and both ENUMs.

### Step 2: Fresh Database Deployment
For a completely fresh deployment:
```bash
docker-compose down -v  # Remove old volumes
docker-compose up -d    # Start with fresh database
```

### Step 3: Migration for Existing Data
For deployments with existing data, use:
```bash
./apply-session-token-migration.sh
```

### Step 4: Verify Deployment
Check that all 9 tables exist:
```sql
SELECT table_name FROM information_schema.tables 
WHERE table_schema = 'public' 
ORDER BY table_name;
```

Expected output:
- chat_messages
- chat_participants  
- generated_links
- session ‚Üê **CRITICAL - Must be present**
- session_tokens
- short_links
- short_viewer_links
- users
- viewer_links

## Common Issues and Solutions

### Issue: "relation session does not exist"
**Cause**: Missing session table
**Solution**: Use the updated init.sql or run migration script

### Issue: "type user_role does not exist" 
**Cause**: Missing enum types
**Solution**: Create enum types before tables

### Issue: Chat system errors
**Cause**: Missing chat_messages or chat_participants tables
**Solution**: Ensure all 9 tables are created

## Production Checklist

- [ ] All 9 tables created
- [ ] Both ENUM types created  
- [ ] Session table present (authentication critical)
- [ ] Performance indexes created
- [ ] Default admin user created
- [ ] Database permissions set correctly

## Default Credentials
- Username: `admin`
- Password: `virtualaudience2025`
- **CHANGE IMMEDIATELY AFTER DEPLOYMENT**